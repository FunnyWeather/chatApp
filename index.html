<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
</head>
<body style="background-color: #3d3d3d; color: white;">
    <style>
    body {
        background-color: #0d1b2a; /* Dark navy */
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    h2 {
        margin-bottom: 20px;
        color: #4da6ff; /* Bright blue */
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
        width: 250px;
    }

    input {
        padding: 10px;
        border-radius: 5px;
        border: none;
        outline: none;
        font-size: 1em;
        background-color: #1b2a47; /* Medium dark blue */
        color: #e0e0e0;
    }

    button {
        padding: 10px;
        border-radius: 5px;
        border: none;
        background-color: #4da6ff; /* Bright blue */
        color: #0d1b2a; /* Dark navy */
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    button:hover {
        background-color: #3399ff;
    }

    #status {
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #ff6666; /* Red-ish for errors */
    }

    #logout {
        position: absolute;
        top: 20px;
        right: 50px;
    }

    #userDiv {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 300px;
        margin-bottom: 20px;
    }
      
    #chat {
        width: 100%;
        max-width: 800px;
        background-color: #1b2a47; /* Same as input */
        border-radius: 10px;
        padding: 10px;
        overflow-y: auto;
        max-height: 400px;
    }
    
    @keyframes fadeMessage {
        from {
          background-color: rgb(95, 50, 200); /* starting color */
        }
        to {
          background-color: rgb(70, 70, 70);  /* final color */
        }
    }

    .chat-message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
        background-color: #273859; /* Slightly lighter blue for contrast */
        animation: fadeMessage 2s forwards;
    }

    .chat-message b {
        color: #4da6ff; /* Bright blue username */
    }

    .chat-message span {
        font-size: 0.8em;
        color: #a0c4ff; /* Soft light blue for time */
    }

    #chatContainer {
      display: flex;
      gap: 20px;          /* space between chat and private messages */
    }

    #chat {
      flex: 2;            /* take more space */
      background: #222;
      padding: 10px;
      border-radius: 8px;
      color: white;
    }

    #privateMessages {
      flex: 1;            /* narrower column */
      background: #333;
      padding: 10px;
      border-radius: 8px;
      color: white;
    }

    #maurice {
      position: absolute;
      top: 0px;
      left: 50vw;
      width: auto;
      height: 50px;
    }
    
    #gabriel {
      position: absolute;
      top: 50px;
      left: 50vw;
      width: auto;
      height: 50px;
    }

    #terminal {
      display: none;
      position: absolute;
      top: 0px;
      left: 0px;
      width: 20vw;
      height: 100vh;
      background-color: #222222;
    }

    #terminal input {
      background-color: #252525;
    }

    #terminal button {
        background-color: #333;
    }
    </style>

    <h2 id="top-text">Login / Register</h2>
    <div class="input-group">
    <input id="username" placeholder="Username">
    <input id="password" placeholder="Password" type="password">
    <button id="loginBtn">Login / Register</button>
    </div>
    <div id="status"></div>

    <div id="userDiv" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="userName"></span>
        <button id="logout">Logout</button>
    </div>
    <div style="display:flex; gap:10px;">
        <input id="msg" placeholder="Type a message..." style="flex:1;">
        <button id="send">Send</button>
    </div>
    </div>

    <div id="chatContainer">
      <div id="chat"></div>
      <div id="privateMessages"></div>
    </div>

    <div id="terminal">
      <input id="command">
      <button id="run"> run </button>
    </div>

    <img src="download (9).jpeg" alt="no maurice" id="maurice"></img>
    <img src="gabriel.jpeg" alt="no daddy" id="gabriel"></img>

    <p style="text-align:center; position:absolute; bottom:20px; left:50vw"> version: beta-1.2.2.e </p>

  <script type="module">
    import { doc, deleteDoc, getDoc} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, where, updateDoc, arrayUnion } 
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyADuus9QP-KyaUd5SrY5IMP2_DZfNMbaDs",
        authDomain: "chatdata-d1bb0.firebaseapp.com",
        projectId: "chatdata-d1bb0",
        storageBucket: "chatdata-d1bb0.firebasestorage.app",
        messagingSenderId: "454474717430",
        appId: "1:454474717430:web:588dee91a19bd72bc9b4d7",
        measurementId: "G-0PQFE6PHVM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logout");
    const userDiv = document.getElementById("userDiv");
    const userNameSpan = document.getElementById("userName");
    const sendBtn = document.getElementById("send");
    const msgInput = document.getElementById("msg");
    const chatDiv = document.getElementById("chat");
    const privateChat = document.getElementById("privateMessages");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const statusDiv = document.getElementById("status");
    const topText = document.getElementById("top-text")
    const terminal = document.getElementById("terminal");
    const command = document.getElementById("command");
    const run = document.getElementById("run");

    let currentUser = null;
    let currentRole = null;
    let ISADMIN = false;
    
    const refreshRef = doc(db, "triggers", "refresh");
    
    onSnapshot(refreshRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.value === 1) {
          console.log("Global refresh triggered!");
          location.reload(); // force reload
        }
      }
    });

    run.onclick = async () => {
      const text = command.value.trim();
      const line = text.split(":");
      const instr = line[0];
      const args = line.slice(1);
      if(instr === "/deleteAll") {
        deleteAll(args[0]);
      }

      if(instr === "/refresh") {
        triggerRefresh()
      }

      if(instr === "/ban") {
        const user = args[0];

        const q = query(collection(db, "users"), where("username", "==", user));
        const snap = await getDocs(q);

        if(!snap.empty) {
          const ip = snap.docs[0].data().ip;
          ban(ip);
        }
      }
    }

    async function triggerRefresh() {
      const refreshRef = doc(db, "triggers", "refresh");
      await updateDoc(refreshRef, { value: 1 });
    
      // Optional: reset back to 0 after a short delay
      setTimeout(async () => {
        await updateDoc(refreshRef, { value: 0 });
      }, 2000);
    }
    
    // Login / Register
    loginBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!username || !password) {
        statusDiv.innerText = "Enter username and password!";
        return;
      }

      const usersRef = collection(db, "users");
      let q = query(usersRef, where("username", "==", username));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        // Register new user
        const ip = await getVisitorIP();

        q = query(
          collection(db, "banned"),
          where("ips", "array-contains", ip)
        );
        
        const snap = await getDocs(q);

        if(!snap.empty) {
          topText.textContent = "YOU ARE BANNED.";
          return;
        }
        
        await addDoc(usersRef, { username, password, role: "user", ip});
        //statusDiv.innerText = "Registered and logged in!";
        currentRole = "user";
        currentUser = username;
        enableChat();
      } else {
        // Check password
        const userDoc = snapshot.docs[0];

        q = query(
          collection(db, "banned"),
          where("ips", "array-contains", userDoc.data().ip)
        );
        
        const snap = await getDocs(q);

        if(!snap.empty) {
          topText.textContent = "YOU ARE BANNED.";
          return;
        
        
        if (userDoc.data().password === password) {
          //statusDiv.innerText = "Logged in!";
          currentRole = userDoc.data().role;
          currentUser = username;
          enableChat();
        } else {
          statusDiv.innerText = "Wrong password!";
        }
      }
    };
    
    let chatUnsub = null;
    let privateUnsub = null;
    let hasSeenMessage = true;

    function enableChat() {
      userDiv.style.display = "block";
      userNameSpan.textContent = "Logged in as: " + currentUser;
      usernameInput.style.display = "none";
      passwordInput.style.display = "none";
      loginBtn.style.display = "none";
      topText.textContent = "";
    
      if (currentRole === "Admin") {
        ISADMIN = true;
        terminal.style.display = "block";
      }

      function ISOPEN() {
        if(document.visibilityState === "visible") {
          document.title = "Chat";
        }
      }

      setInterval(ISOPEN, 100);
    
      refreshDM();
    
      // start listeners here
      if (!chatUnsub) {
        const chatQuery = query(collection(db, "messages"), orderBy("time"));
        chatUnsub = onSnapshot(chatQuery, snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const time = new Date(data.time).toLocaleTimeString();
    
            const deleteButton = (data.user === currentUser || ISADMIN) 
              ? `<button onclick="deleteMessage('${change.doc.id}')">Delete</button>` 
              : "";
    
            if (change.type === "added") {
              document.title = "new message!";
              chatDiv.innerHTML += `
                <div id="msg-${change.doc.id}" class="chat-message" 
                     style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                  <b>${data.user} | </b> 
                  <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                  ${data.message}<br>
                </div>
              `;
            } else if (change.type === "removed") {
              const msgDiv = document.getElementById(`msg-${change.doc.id}`);
              if (msgDiv) msgDiv.remove();
            }
          });
        });
      }
    
      if (!privateUnsub) {
        const privateQuery = query(collection(db, "private messages"), orderBy("time"));
        privateUnsub = onSnapshot(privateQuery, snapshot => {
          privateChat.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString();
    
            const deleteButton = (ISADMIN)
              ? `<button onclick="deleteDM('${doc.id}')">Delete</button>` 
              : "";
    
            if (currentUser === data.recipient || currentUser === data.user || ISADMIN) {
              privateChat.innerHTML += `
                <div style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                  <b>${data.user} --> ${data.recipient} | </b> 
                  <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                  ${data.message}<br>
                </div>
              `;
            }
          });
        });
      }
    }
    // Logout
    logoutBtn.onclick = () => {
      currentUser = null;
      userDiv.style.display = "none";
      usernameInput.style.display = "inline";
      passwordInput.style.display = "inline";
      loginBtn.style.display = "inline";
      statusDiv.innerText = "";
      topText.textContent = "Login / Register";
    };

    let bannedWords = ["fuck","shit","ass","nigga","nigger","bitch"];

    function containsBannedWord(message) {
      let clean = message.toLowerCase();
      clean = clean.replace(/[^a-z0-9\s]/g, ""); // remove symbols
      const words = clean.split(/\s+/);
      return words.some(w => bannedWords.includes(w));
    }

    // Send message
    sendBtn.onclick = async () => {
      const msg = msgInput.value.trim();
      if (!msg || !currentUser) return;
      msgInput.value = "";

      if (msg.startsWith("/dm ")) {
        // format: /dm recipient message
        const parts = msg.split(" ");
        const recipient = parts[1];
        const privateMsg = parts.slice(2).join(" ");
        if (recipient && privateMsg) {
          await addDoc(collection(db, "private messages"), {
            user: currentUser,
            recipient: recipient,
            message: privateMsg,
            time: Date.now()
          });
        }
      } else {
        if(containsBannedWord(msg)) {
          alert("innapropriate words detected, please remove.");
          return;
        }

        await addDoc(collection(db, "messages"), {
          user: currentUser,
          message: msg,
          time: Date.now()
        });
      }
    };

    async function ban(ip) {
      try {
        const bannedRef = doc(db, "banned", "banned IP");
    
        await updateDoc(bannedRef, {
          ips: arrayUnion(ip) // adds only if not already present
        });
    
        console.log(`Banned IP: ${ip}`);
      } catch (err) {
        console.error("Error banning IP:", err);
      }
    }

    async function refreshDM() {
        const chatQuery = query(collection(db, "private messages"), orderBy("time"));
        const snapshot = await getDocs(chatQuery);

        privateChat.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString(); // format timestamp

            const deleteButton = (ISADMIN) 
                ? `<button onclick="deleteDM('${doc.id}')">Delete</button>` 
                : "";

            if(currentUser === data.recipient || currentUser === data.user || ISADMIN) { // or user is admin, show
                privateChat.innerHTML += `
                <div style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                    <b>${data.user} --> ${data.recipient} | </b> <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                    ${data.message}<br>
                </div>
                `;
            }
        });
    }

    async function getVisitorIP() {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip; // this is the visitor's public IP
    }

    // Function to delete a message
    window.deleteMessage = async (id) => {
        const docRef = doc(db, "messages", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) return;

        const data = docSnap.data();

        if (data.user !== currentUser) {
            if(ISADMIN) {
                await deleteDoc(docRef);
                return
            } else {
                alert("Not your message..");
                return;
            }
        }

        if (confirm("Are you sure you want to delete this message?")) {
            await deleteDoc(docRef);
        }
    };

    window.deleteAll = async (collectionName) => {
      try {
        const colRef = collection(db, collectionName);
        const snapshot = await getDocs(colRef);
    
        if (snapshot.empty) {
          console.log(`No documents found in '${collectionName}'`);
          return;
        }
    
        const deletePromises = snapshot.docs.map((d) => deleteDoc(doc(db, collectionName, d.id)));
        await Promise.all(deletePromises);
    
        console.log(`Deleted ${snapshot.size} documents from '${collectionName}'`);
      } catch (err) {
        console.error("Error deleting documents: ", err);
      }
    }

    window.deleteDM = async (id) => {
        const docRef = doc(db, "private messages", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) return;

        const data = docSnap.data();

        if (confirm("Are you sure you want to delete this message?")) {
            await deleteDoc(docRef);
        }
    };

  </script>
</body>
</html>
