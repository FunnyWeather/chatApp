<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
</head>
<body style="background-color: #3d3d3d; color: white;">
    <style>
    body {
        background-color: #0d1b2a; /* Dark navy */
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    h2 {
        margin-bottom: 20px;
        color: #4da6ff; /* Bright blue */
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
        width: 250px;
    }

    input {
        padding: 10px;
        border-radius: 5px;
        border: none;
        outline: none;
        font-size: 1em;
        background-color: #1b2a47; /* Medium dark blue */
        color: #e0e0e0;
    }

    button {
        padding: 10px;
        border-radius: 5px;
        border: none;
        background-color: #4da6ff; /* Bright blue */
        color: #0d1b2a; /* Dark navy */
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    button:hover {
        background-color: #3399ff;
    }

    #status {
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #ff6666; /* Red-ish for errors */
    }

    #logout {
        position: absolute;
        top: 20px;
        right: 50px;
    }

    #userDiv {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 300px;
        margin-bottom: 20px;
    }

    #chat {
        width: 100%;
        max-width: 500px;
        background-color: #1b2a47; /* Same as input */
        border-radius: 10px;
        padding: 10px;
        overflow-y: auto;
        max-height: 400px;
    }
    
    @keyframes fadeMessage {
        from {
          background-color: rgb(95, 50, 200); /* starting color */
        }
        to {
          background-color: rgb(70, 70, 70);  /* final color */
        }
    }

    .chat-message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
        background-color: #273859; /* Slightly lighter blue for contrast */
        animation: fadeMessage 2s forwards;
    }

    .chat-message b {
        color: #4da6ff; /* Bright blue username */
    }

    .chat-message span {
        font-size: 0.8em;
        color: #a0c4ff; /* Soft light blue for time */
    }

    #chatContainer {
      display: flex;
      gap: 20px;          /* space between chat and private messages */
    }

    #chat {
      flex: 2;            /* take more space */
      background: #222;
      padding: 10px;
      border-radius: 8px;
      color: white;
    }

    #privateMessages {
      flex: 1;            /* narrower column */
      background: #333;
      padding: 10px;
      border-radius: 8px;
      color: white;
    }

    #maurice {
      position: absolute;
      top: 0px;
      left: 0px;
    }
    </style>

    <h2 id="top-text">Login / Register</h2>
    <div class="input-group">
    <input id="username" placeholder="Username">
    <input id="password" placeholder="Password" type="password">
    <button id="loginBtn">Login / Register</button>
    </div>
    <div id="status"></div>

    <div id="userDiv" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="userName"></span>
        <button id="logout">Logout</button>
    </div>
    <div style="display:flex; gap:10px;">
        <input id="msg" placeholder="Type a message..." style="flex:1;">
        <button id="send">Send</button>
    </div>
    </div>

    <div id="chatContainer">
      <div id="chat"></div>
      <div id="privateMessages"></div>
    </div>

    <img id="maurice" src="download (9).jpeg" alt="no maurice"></img>
    <img id="gabriel" src="gabriel.jpeg" alt="no daddy"</img>

  <script type="module">
    import { doc, deleteDoc, getDoc} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, where } 
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyADuus9QP-KyaUd5SrY5IMP2_DZfNMbaDs",
        authDomain: "chatdata-d1bb0.firebaseapp.com",
        projectId: "chatdata-d1bb0",
        storageBucket: "chatdata-d1bb0.firebasestorage.app",
        messagingSenderId: "454474717430",
        appId: "1:454474717430:web:588dee91a19bd72bc9b4d7",
        measurementId: "G-0PQFE6PHVM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let ISISAIHAH = false;

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logout");
    const userDiv = document.getElementById("userDiv");
    const userNameSpan = document.getElementById("userName");
    const sendBtn = document.getElementById("send");
    const msgInput = document.getElementById("msg");
    const chatDiv = document.getElementById("chat");
    const privateChat = document.getElementById("privateMessages");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const statusDiv = document.getElementById("status");
    const topText = document.getElementById("top-text")

    let currentUser = null;
    let ISADMIN = false;

    // Login / Register
    loginBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!username || !password) {
        statusDiv.innerText = "Enter username and password!";
        return;
      }

      const usersRef = collection(db, "users");
      const q = query(usersRef, where("username", "==", username));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        // Register new user
        await addDoc(usersRef, { username, password });
        //statusDiv.innerText = "Registered and logged in!";
        currentUser = username;
        enableChat();
      } else {
        // Check password
        const userDoc = snapshot.docs[0];
        if (userDoc.data().password === password) {
          //statusDiv.innerText = "Logged in!";
          currentUser = username;
          enableChat();
        } else {
          statusDiv.innerText = "Wrong password!";
        }
      }
    };
    let chatUnsub = null;
    let privateUnsub = null;

    function enableChat() {
      userDiv.style.display = "block";
      userNameSpan.textContent = "Logged in as: " + currentUser;
      usernameInput.style.display = "none";
      passwordInput.style.display = "none";
      loginBtn.style.display = "none";
      topText.textContent = "";
    
      if (currentUser === "Admin") {
        ISADMIN = true;
      }

      if(currentUser === "Isaiah.") {
        ISISAIHAH = true
      }
    
      refreshDM();
    
      // start listeners here
      if (!chatUnsub) {
        const chatQuery = query(collection(db, "messages"), orderBy("time"));
        chatUnsub = onSnapshot(chatQuery, snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const time = new Date(data.time).toLocaleTimeString();
    
            const deleteButton = (data.user === currentUser || ISADMIN) 
              ? `<button onclick="deleteMessage('${change.doc.id}')">Delete</button>` 
              : "";
    
            if (change.type === "added") {
              chatDiv.innerHTML += `
                <div id="msg-${change.doc.id}" class="chat-message" 
                     style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                  <b>${data.user} | </b> 
                  <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                  ${data.message}<br>
                </div>
              `;
            } else if (change.type === "removed") {
              const msgDiv = document.getElementById(`msg-${change.doc.id}`);
              if (msgDiv) msgDiv.remove();
            }
          });
        });
      }
    
      if (!privateUnsub) {
        const privateQuery = query(collection(db, "private messages"), orderBy("time"));
        privateUnsub = onSnapshot(privateQuery, snapshot => {
          privateChat.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString();
    
            const deleteButton = (ISADMIN)
              ? `<button onclick="deleteDM('${doc.id}')">Delete</button>` 
              : "";
    
            if (currentUser === data.recipient || currentUser === data.user || ISADMIN) {
              privateChat.innerHTML += `
                <div style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                  <b>${data.user} --> ${data.recipient} | </b> 
                  <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                  ${data.message}<br>
                </div>
              `;
            }
          });
        });
      }
    }
    // Logout
    logoutBtn.onclick = () => {
      currentUser = null;
      userDiv.style.display = "none";
      usernameInput.style.display = "inline";
      passwordInput.style.display = "inline";
      loginBtn.style.display = "inline";
      statusDiv.innerText = "";
      topText.textContent = "Login / Register";
    };

    let bannedWords = [];

    function containsBannedWord(message) {
      let clean = message.toLowerCase();
      clean = clean.replace(/[^a-z0-9\s]/g, ""); // remove symbols
      const words = clean.split(/\s+/);
      return words.some(w => bannedWords.includes(w));
    }

    // Send message
    sendBtn.onclick = async () => {
      const msg = msgInput.value.trim();
      if (!msg || !currentUser) return;
      msgInput.value = "";

      if(ISISAIHAH) {
        return;
      }

      if (msg.startsWith("/dm ")) {
        // format: /dm recipient message
        const parts = msg.split(" ");
        const recipient = parts[1];
        const privateMsg = parts.slice(2).join(" ");
        if (recipient && privateMsg) {
          await addDoc(collection(db, "private messages"), {
            user: currentUser,
            recipient: recipient,
            message: privateMsg,
            time: Date.now()
          });
        }
      } else {
        if(containsBannedWord(msg)) {
          alert("innapropriate words detected, please remove.");
          return;
        }

        await addDoc(collection(db, "messages"), {
          user: currentUser,
          message: msg,
          time: Date.now()
        });
      }
    };


    /* Listen for messages
    const chatQuery = query(collection(db, "messages"), orderBy("time"));
    onSnapshot(chatQuery, snapshot => {
        snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const time = new Date(data.time).toLocaleTimeString();

            const deleteButton = (data.user === currentUser || ISADMIN) 
                ? `<button onclick="deleteMessage('${change.doc.id}')">Delete</button>` 
                : "";

            if (change.type === "added") {
                chatDiv.innerHTML += `
                <div id="msg-${change.doc.id}" style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;" class="chat-message">
                    <b>${data.user} | </b> <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                    ${data.message}<br>
                </div>
                `;
            } else if (change.type === "removed") {
                const msgDiv = document.getElementById(`msg-${change.doc.id}`);
                if (msgDiv) msgDiv.remove();
            }
        });
    });

    const privateQuery = query(collection(db, "private messages"), orderBy("time"));
    onSnapshot(privateQuery, snapshot => {
        privateChat.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString(); // format timestamp

            const deleteButton = (ISADMIN)
                ? `<button onclick="deleteDM('${doc.id}')">Delete</button>` 
                : "";

              if(currentUser === data.recipient || currentUser === data.user || currentUser === "Admin") { // or user is admin, show
                  privateChat.innerHTML += `
                  <div style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                      <b>${data.user} --> ${data.recipient} | </b> <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                      ${data.message}<br>
                  </div>
                  `;
              }
        });
    });*/

    async function refreshMessages() {
        const chatQuery = query(collection(db, "messages"), orderBy("time"));
        const snapshot = await getDocs(chatQuery);

        chatDiv.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString(); // format timestamp

            chatDiv.innerHTML += `
            <div id="msg-${doc.id}" style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;" class="chat-message">
                <b>${data.user} | </b> <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                ${data.message}<br>
            </div>
            `;
        });
    }

    async function refreshDM() {
        const chatQuery = query(collection(db, "private messages"), orderBy("time"));
        const snapshot = await getDocs(chatQuery);

        privateChat.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const time = new Date(data.time).toLocaleTimeString(); // format timestamp

            const deleteButton = (currentUser === "Admin") 
                ? `<button onclick="deleteDM('${doc.id}')">Delete</button>` 
                : "";

            if(currentUser === data.recipient || currentUser === data.user || currentUser === "Admin") { // or user is admin, show
                privateChat.innerHTML += `
                <div style="margin: 5px; padding: 8px; border-radius: 5px; background-color: #555;">
                    <b>${data.user} --> ${data.recipient} | </b> <span style="font-size: 0.8em; color: #ccc;">${time} ${deleteButton}</span><br>
                    ${data.message}<br>
                </div>
                `;
            }
        });
    }

    // Function to delete a message
    window.deleteMessage = async (id) => {
        const docRef = doc(db, "messages", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) return;

        const data = docSnap.data();

        if (data.user !== currentUser) {
            if(ISADMIN) {
                await deleteDoc(docRef);
                return
            } else {
                alert("Not your message..");
                return;
            }
        }

        if (confirm("Are you sure you want to delete this message?")) {
            await deleteDoc(docRef);
        }
    };

    window.deleteDM = async (id) => {
        const docRef = doc(db, "private messages", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) return;

        const data = docSnap.data();

        if (confirm("Are you sure you want to delete this message?")) {
            await deleteDoc(docRef);
        }
    };

  </script>
</body>
</html>
