<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
</head>
<body style="background-color: #3d3d3d; color: white;">
  <style>
    body { font-family: Arial, Helvetica, sans-serif; }
    
    #broadcastDiv {   
      display: flex;
      justify-content: center;
      width: 50vw;
    }
  </style>

  <div id="broadcastDiv" style="background-color: #2d2d2d">
    <h2 style="text-align: center;" id="broadcast">no broadcast at the moment</h2>
  </div>

  <!-- LOGIN UI -->
  <div id="loginBox">
    <h2>Login</h2>
    <input id="username" placeholder="Username"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
  </div>

  <!-- CHAT UI -->
  <div id="chatUI" style="display:none;">
    <button id="logoutBtn">Logout</button><br><br>

    <div style="display:flex; align-items:center; gap:8px;">
      <input id="msg" placeholder="message">
      <button id="send">Send</button>

      <!-- ✅ Inline character counter -->
      <span id="charCount" style="margin-left: 10px; color:#bbb;">250</span>
    </div>

    <div id="chat"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      doc,
      updateDoc,
      getDocs,
      orderBy,
      onSnapshot,
      increment
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADuus9QP-KyaUd5SrY5IMP2_DZfNMbaDs",
      authDomain: "chatdata-d1bb0.firebaseapp.com",
      projectId: "chatdata-d1bb0",
      storageBucket: "chatdata-d1bb0.firebasestorage.app",
      messagingSenderId: "454474717430",
      appId: "1:454474717430:web:588dee91a19bd72bc9b4d7",
      measurementId: "G-0PQFE6PHVM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let accountName = "";
    let userIP = "";

    const loginBox = document.getElementById("loginBox");
    const chatUI = document.getElementById("chatUI");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInput = document.getElementById("username");
    const passInput = document.getElementById("password");
    const sendBtn = document.getElementById("send");
    const msgInput = document.getElementById("msg");
    const chatDiv = document.getElementById("chat");
    const broadcastText = document.getElementById("broadcast");
    const charCount = document.getElementById("charCount");

    const listenersRef = doc(db, "triggers", "listeners");
    const canChatRef = doc(db, "triggers", "chat");
    const refreshRef = doc(db, "triggers", "refresh");
    const broadcastRef = doc(db, "broadcasts", "broadcast");
    const announcementRef = doc(db, "broadcasts", "announcement");
    const closeRef = doc(db, "triggers", "close");

    function hasEmojis(str) {
      const emojiRegex = /\p{Emoji}/u;
      return emojiRegex.test(str);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        document.title = "Chat";
      }
    });

    // ---------------- CLOSING ----------------

    let lastCloseValue = null;
    onSnapshot(closeRef, (docSnap) => {
      if (docSnap.exists()) {
        const currentValue = Number(docSnap.data().value);
        if (lastCloseValue !== null && currentValue !== lastCloseValue) {
          document.body.innerHTML = "";
          const h1element = document.createElement("h1");
          h1element.textContent = "CLOSE THIS PAGE NOW. DO NOT REFRESH... CLOSE IT AND REOPEN";
          document.body.appendChild(h1element);
          console.log("closing");
        }
        lastCloseValue = currentValue;
      }
    });

    // ---------------- BROADCAST ----------------
    onSnapshot(broadcastRef, (docSnap) => {
      if (docSnap.exists()) {
        broadcastText.innerHTML = docSnap.data().message;
      }
    });

    onSnapshot(announcementRef, (docSnap) => {
      if (docSnap.exists() && docSnap.data().message !== "") {
        alert(docSnap.data().message);
      }
    });

    let canChat = true;

    // ---------------- REFRESH LISTENER ----------------
    let lastRefreshValue = null;
    onSnapshot(refreshRef, (docSnap) => {
      if (docSnap.exists()) {
        const currentValue = Number(docSnap.data().value);
        if (lastRefreshValue !== null && currentValue !== lastRefreshValue) location.reload();
        lastRefreshValue = currentValue;
      }
    });

    // ---------------- HEARTBEAT ----------------
    async function startHeartbeat() {
      await updateDoc(listenersRef, { value: increment(1) });
    }
    window.addEventListener("beforeunload", async () => {
      try { await updateDoc(listenersRef, { value: increment(-1) }); } catch {}
    });
    startHeartbeat();

    // ---------------- canChat Listener ----------------
    onSnapshot(canChatRef, (docSnap) => {
      if (docSnap.exists()) canChat = Boolean(Number(docSnap.data().value));
    });

    // ---------------- GET PUBLIC IP ----------------
    async function getVisitorIP() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch {
        return "unknown";
      }
    }

    // ---------------- CHECK IF BANNED ----------------
    async function isBanned(ip) {
      const bannedRef = collection(db, "banned");
      const q = query(bannedRef, where("ips", "array-contains", ip));
      const snap = await getDocs(q);
      return !snap.empty;
    }

    // ---------------- LOGIN / SIGNUP ----------------
    loginBtn.onclick = async () => {
      const u = userInput.value.trim();
      const p = passInput.value.trim();
      if (!u || !p) return alert("Enter username and password");

      userIP = await getVisitorIP();

      if (await isBanned(userIP)) {
        return alert("You are banned from this chat.");
      }

      const usersRef = collection(db, "users");
      const qUsername = query(usersRef, where("username", "==", u));
      const snap = await getDocs(qUsername);

      if (snap.size > 0) {
        const userData = snap.docs[0].data();
        if (userData.password === p) {
          accountName = u;
          loginBox.style.display = "none";
          chatUI.style.display = "block";
          return;
        } else {
          alert("Password incorrect.");
          return;
        }
      }

      if(!hasEmojis(u) || userInput.value.length > 30) {
        await addDoc(usersRef, { username: u, password: p, ip: userIP });
      } else {
        alert("no good name. length must be less than 30 and no emojis.");
        return;
      }
      accountName = u;
      loginBox.style.display = "none";
      chatUI.style.display = "block";
    };

    // ---------------- LOGOUT ----------------
    logoutBtn.onclick = async () => {
      try { await updateDoc(listenersRef, { value: increment(-1) }); } catch {}
      accountName = "";
      userInput.value = "";
      passInput.value = "";
      chatUI.style.display = "none";
      loginBox.style.display = "block";
    };

    // ✅ ---------------- INLINE CHARACTER COUNTER ----------------
    const MAX_CHARS = 250;
    msgInput.addEventListener("input", () => {
      const remaining = MAX_CHARS - msgInput.value.length;
      charCount.textContent = `${remaining}`;
      charCount.style.color = remaining < 0 ? "red" : "#bbb";
    });

    // ---------------- SEND MESSAGE ----------------
    sendBtn.onclick = async () => {
      if (!canChat) return alert("Can't chat");
      const raw = msgInput.value.trim();
      if (!raw) return;

      if (raw.length > 250) {
        alert("message too long");
        return;
      }

      if (/<\/?[^>]+>/gi.test(raw)) return alert("HTML not allowed");
      const forbidden = ["data:image/", "<img", ".jpg", ".jpeg", ".png", ".gif", ".webp", ".bmp", "base64,"];
      if (forbidden.some(p => raw.toLowerCase().includes(p))) return alert("Images not allowed");

      await addDoc(collection(db, "messages"), { user: accountName, message: raw, time: Date.now() });
      msgInput.value = "";
      charCount.textContent = MAX_CHARS; // reset
    };

    // ---------------- REAL-TIME CHAT ----------------
    onSnapshot(query(collection(db, "messages"), orderBy("time")), snapshot => {
      chatDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const line = document.createElement("div");
        const userSpan = document.createElement("b");
        userSpan.textContent = data.user + ": ";
        const msgSpan = document.createElement("span");
        msgSpan.textContent = data.message;
        line.appendChild(userSpan);
        line.appendChild(msgSpan);
        chatDiv.appendChild(line);
        if (document.visibilityState === "hidden") {
          document.title = "new message";
        }
      });
    });
  </script>
</body>
</html>
